# hw08: 服务间通信与负载均衡

**作业编号**：hw08

## 贯穿项目里程碑

本周任务是在 hw07 的 Nacos 注册中心基础上，实现服务间通信（使用 OpenFeign）和负载均衡（使用 Ribbon），完善微服务架构的核心功能。

---

## 版本信息

- **项目名称：** course-cloud
- **版本号：** v1.2.0（引入服务间通信与负载均衡）
- **基于版本：** v1.1.0

---

## 系统架构说明

系统架构演进为：

`Enrollment Service` → `OpenFeign + Ribbon` → `Catalog Service`

Enrollment Service 需要调用 Catalog Service 验证课程信息，通过 OpenFeign 实现声明式服务调用，通过 Ribbon 实现客户端负载均衡。

---

## 核心任务

- 在 Enrollment Service 中集成 OpenFeign
- 创建 Feign Client 接口调用 Catalog Service
- 配置 Ribbon 负载均衡策略
- 实现选课时的课程信息验证
- 启动多个 Catalog Service 实例验证负载均衡
- 完成后打 tag：`v1.2.0`

---

## 任务详解

### 1. 添加 OpenFeign 依赖

在 `enrollment-service/pom.xml` 中添加：

```xml
<!-- OpenFeign -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>

<!-- Ribbon (通常由 OpenFeign 传递依赖) -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
</dependency>
```

### 2. 启用 Feign Client

在 `EnrollmentServiceApplication.java` 中添加注解：

```java
@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
public class EnrollmentServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentServiceApplication.class, args);
    }
}
```

### 3. 创建 Feign Client 接口

在 `enrollment-service` 中创建 `CatalogClient.java`：

```java
@FeignClient(name = "catalog-service")
public interface CatalogClient {

    @GetMapping("/courses/{courseId}")
    CourseDTO getCourseById(@PathVariable("courseId") Long courseId);

    @GetMapping("/courses/{courseId}/available")
    Boolean isCourseAvailable(@PathVariable("courseId") Long courseId);
}
```

### 4. 配置 Ribbon 负载均衡

在 `application.yml` 中配置：

```yaml
# Ribbon 配置
catalog-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule # 随机策略
    # 其他可选策略：
    # RoundRobinRule - 轮询（默认）
    # WeightedResponseTimeRule - 响应时间加权
    # BestAvailableRule - 最小并发请求
```

### 5. 在选课逻辑中调用 Catalog Service

修改 `EnrollmentService.java`：

```java
@Service
public class EnrollmentService {

    @Autowired
    private CatalogClient catalogClient;

    @Autowired
    private EnrollmentRepository enrollmentRepository;

    public Enrollment createEnrollment(EnrollmentRequest request) {
        // 1. 调用 Catalog Service 验证课程
        CourseDTO course = catalogClient.getCourseById(request.getCourseId());
        if (course == null) {
            throw new CourseNotFoundException("课程不存在");
        }

        // 2. 检查课程是否可选
        Boolean available = catalogClient.isCourseAvailable(request.getCourseId());
        if (!available) {
            throw new CourseNotAvailableException("课程已满或不可选");
        }

        // 3. 创建选课记录
        Enrollment enrollment = new Enrollment();
        enrollment.setStudentId(request.getStudentId());
        enrollment.setCourseId(request.getCourseId());
        enrollment.setCourseName(course.getName());
        enrollment.setEnrollTime(LocalDateTime.now());

        return enrollmentRepository.save(enrollment);
    }
}
```

### 6. 测试负载均衡

**启动多个 Catalog Service 实例**：

```bash
# 实例 1 - 端口 8081
java -jar catalog-service.jar --server.port=8081

# 实例 2 - 端口 8082
java -jar catalog-service.jar --server.port=8082

# 实例 3 - 端口 8083
java -jar catalog-service.jar --server.port=8083
```

**测试选课接口**：

```bash
curl -X POST http://localhost:8083/enrollments \
  -H "Content-Type: application/json" \
  -d '{
    "studentId": 1,
    "courseId": 101
  }'
```

观察 Catalog Service 日志，验证请求是否按照配置的负载均衡策略分发。

### 7. Feign 配置优化

在 `application.yml` 中配置 Feign：

```yaml
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: basic
  compression:
    request:
      enabled: true
    response:
      enabled: true
```

### 测试场景

1. **正常选课**：课程存在且可选，验证选课成功
2. **课程不存在**：验证返回 404 错误
3. **课程已满**：验证返回业务异常
4. **负载均衡**：启动多个 Catalog Service，观察请求分发

### 目录结构建议

```text
enrollment-service/
  src/main/java/com/zjgsu/szw/coursecloud/enrollment/
    client/
      CatalogClient.java
      dto/
        CourseDTO.java
    service/
      EnrollmentService.java
    exception/
      CourseNotFoundException.java
      CourseNotAvailableException.java
```

### 提交要求

- OpenFeign 集成正确
- Feign Client 接口定义完整
- Ribbon 负载均衡配置有效
- 选课逻辑能正确调用 Catalog Service
- 多实例负载均衡测试通过

### 评分标准

- OpenFeign 依赖与配置 (20%)
- Feign Client 接口设计 (25%)
- Ribbon 负载均衡配置 (20%)
- 业务逻辑实现 (25%)
- 文档与测试 (10%)
