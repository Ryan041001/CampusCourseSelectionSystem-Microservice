# hw09: API 网关与统一认证

**作业编号**：hw09

## 贯穿项目里程碑

本周任务是在 hw08 的 OpenFeign 和负载均衡基础上，搭建 API 网关作为系统统一入口，并实现基于 JWT 的统一认证机制，替代各服务独立认证的方式。

---

## 版本信息

- **项目名称：** course-cloud
- **版本号：** v2.0.0（引入 API Gateway，重大架构变更）
- **基于版本：** v1.2.0

---

## 系统架构说明

系统架构演进为：

`客户端` → `Gateway (8090)` → `User / Catalog / Enrollment Services`

所有外部请求必须经过 Gateway，Gateway 负责统一 JWT 认证，通过后将用户信息写入请求头，下游服务不再验证 Token。

---

## 核心任务

- 创建 Gateway 服务（端口 8090），集成 Spring Cloud Gateway + Nacos
- 配置路由规则转发到各微服务
- 在 User Service 实现登录接口（验证密码 + 生成 JWT）
- 创建 JWT 工具类（HS512、有效期 24h）
- 在 Gateway 中实现 JWT 认证过滤器
- 配置跨域
- 完成后打 tag：`v2.0.0`

---

## 任务详解

### 1. 创建 Gateway 服务

创建 `gateway-service` 模块，添加依赖：

```xml
<!-- Spring Cloud Gateway -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>

<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
```

### 2. Gateway 配置文件（application.yml）

关键配置：

- `server.port = 8090`
- `routes` 路由规则
- `global CORS`
- `jwt.secret` / `jwt.expiration`

示例路由：

```yaml
routes:
  - id: user-service
    uri: lb://user-service
    predicates:
      - Path=/api/users/**
    filters:
      - StripPrefix=1
```

### 3. JWT 工具类

核心方法：

- `generateToken()`
- `parseToken()`
- `validateToken()`

示例：

```java
public String generateToken(String userId, String username, String role) {
    Date now = new Date();
    Date expiryDate = new Date(now.getTime() + expiration);
    return Jwts.builder()
        .setSubject(userId)
        .claim("username", username)
        .claim("role", role)
        .setIssuedAt(now)
        .setExpiration(expiryDate)
        .signWith(Keys.hmacShaKeyFor(secret.getBytes()), SignatureAlgorithm.HS512)
        .compact();
}
```

### 4. 登录接口

```java
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginRequest request) {
    User user = userService.findByUsername(request.getUsername());
    if (user == null || !user.getPassword().equals(request.getPassword())) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("用户名或密码错误");
    }

    String token = jwtUtil.generateToken(
        user.getId().toString(), user.getUsername(), user.getRole());

    return ResponseEntity.ok(new LoginResponse(token, user));
}
```

### 5. JWT 认证过滤器（Gateway）

核心逻辑：

1. 白名单放行
2. 获取 Authorization 头
3. 校验 Token
4. 解析用户信息
5. 添加请求头（`X-User-Id` / `X-Username` / `X-User-Role`）
6. 转发

### 6. 后端服务读取用户信息

```java
@PostMapping
public ResponseEntity<Enrollment> createEnrollment(
    @RequestHeader("X-User-Id") String userId,
    @RequestHeader("X-Username") String username,
    @RequestBody EnrollmentRequest request) {
}
```

### 测试命令

**登录**

```bash
curl -X POST http://localhost:8090/api/auth/login
 -H "Content-Type: application/json"
 -d "{\"username\":\"admin\",\"password\":\"admin123\"}"
```

**携带 Token 请求**

```bash
curl http://localhost:8090/api/users/students
 -H "Authorization: Bearer <token>"
```

### 目录结构建议

```text
gateway-service/
  filter/JwtAuthenticationFilter.java
  util/JwtUtil.java

user-service/
  api/AuthController.java
  util/JwtUtil.java
```

### 提交要求

- Gateway 服务正常启动
- 路由配置正确
- JWT 过滤器实现完整
- 登录返回可用 Token
- 后端能读取请求头

### 评分标准

- Gateway 配置与依赖 (25%)
- JWT 工具类 (20%)
- 登录接口 (20%)
- JWT 过滤器 (25%)
- 文档与测试 (10%)
