# 校园选课系统微服务 - 功能测试文档

**项目名称**: Campus Course Selection System - Microservices  
**版本号**: v1.0.0  
**测试日期**: 2025-11-20  
**测试环境**: Docker Compose  

---

## 目录

1. [测试环境](#测试环境)
2. [测试覆盖范围](#测试覆盖范围)
3. [测试用例](#测试用例)
   - [Catalog Service 测试](#catalog-service-测试)
   - [Enrollment Service 测试](#enrollment-service-测试)
   - [服务间通信测试](#服务间通信测试)
4. [自动化测试脚本](#自动化测试脚本)
5. [测试数据](#测试数据)
6. [已知问题](#已知问题)

---

## 测试环境

### 服务地址

- **Catalog Service (课程目录服务)**: `http://localhost:8081`
- **Enrollment Service (选课服务)**: `http://localhost:8082`
- **Catalog Database**: MySQL 8.4 @ `localhost:3307`
- **Enrollment Database**: MySQL 8.4 @ `localhost:3308`

### 前置条件

1. 所有服务已通过 Docker Compose 启动
2. 数据库初始化完成
3. 服务健康检查通过

### 验证服务状态

```bash
# 检查所有容器运行状态
docker-compose ps

# 查看服务日志
docker-compose logs catalog-service
docker-compose logs enrollment-service
```

---

## 测试覆盖范围

### Catalog Service API (8个端点)

| 序号 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 1 | GET | `/api/courses` | 获取所有课程 |
| 2 | GET | `/api/courses/{id}` | 根据ID获取课程 |
| 3 | GET | `/api/courses/code/{code}` | 根据课程代码获取课程 |
| 4 | POST | `/api/courses` | 创建课程 |
| 5 | PUT | `/api/courses/{id}` | 更新课程 |
| 6 | DELETE | `/api/courses/{id}` | 删除课程 |
| 7 | POST | `/api/courses/{id}/increment` | 增加选课人数 |
| 8 | POST | `/api/courses/{id}/decrement` | 减少选课人数 |

### Enrollment Service API (12个端点)

#### 学生管理 (5个端点)

| 序号 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 1 | GET | `/api/students` | 获取所有学生 |
| 2 | GET | `/api/students/{id}` | 根据ID获取学生 |
| 3 | POST | `/api/students` | 创建学生 |
| 4 | PUT | `/api/students/{id}` | 更新学生信息 |
| 5 | DELETE | `/api/students/{id}` | 删除学生 |

#### 选课管理 (7个端点)

| 序号 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 1 | GET | `/api/enrollments` | 获取所有选课记录 |
| 2 | GET | `/api/enrollments/{id}` | 根据ID获取选课记录 |
| 3 | GET | `/api/enrollments/course/{courseId}` | 按课程查询选课记录 |
| 4 | GET | `/api/enrollments/student/{studentId}` | 按学生查询选课记录 |
| 5 | POST | `/api/enrollments` | 学生选课 |
| 6 | DELETE | `/api/enrollments/{id}` | 学生退课 |

---

## 测试用例

### Catalog Service 测试

#### TC-CS-001: 创建课程 (正常流程)

**测试目标**: 验证能够成功创建新课程

**请求**:
```bash
curl -X POST http://localhost:8081/api/courses \
-H "Content-Type: application/json" \
-d '{
  "code": "CS101",
  "title": "计算机科学导论",
  "instructor": {
    "id": "T001",
    "name": "张教授",
    "email": "zhang@zjgsu.edu.cn"
  },
  "schedule": {
    "dayOfWeek": "MONDAY",
    "startTime": "08:00",
    "endTime": "10:00"
  },
  "capacity": 60,
  "enrolled": 0,
  "expectedAttendance": 50
}'
```

**预期结果**:
- HTTP状态码: `201 Created`
- 响应体包含:
  - `status`: "success"
  - `code`: 201
  - `data`: 包含创建的课程对象 (自动生成UUID ID和createAt时间戳)

**验证点**:
- ✅ 课程代码唯一性
- ✅ ID自动生成
- ✅ enrolled初始值为0
- ✅ createdAt自动设置

---

#### TC-CS-002: 获取所有课程

**测试目标**: 验证能够获取所有课程列表

**请求**:
```bash
curl http://localhost:8081/api/courses
```

**预期结果**:
- HTTP状态码: `200 OK`
- 响应体:
```json
{
  "status": "success",
  "code": 200,
  "message": "Request processed successfully",
  "data": [
    {
      "id": "...",
      "code": "CS101",
      "title": "计算机科学导论",
      ...
    }
  ]
}
```

**验证点**:
- ✅ 返回数组格式
- ✅ 包含之前创建的课程

---

#### TC-CS-003: 根据课程代码查询

**测试目标**: 验证按课程代码查询功能

**请求**:
```bash
curl http://localhost:8081/api/courses/code/CS101
```

**预期结果**:
- HTTP状态码: `200 OK`
- 返回课程代码为 "CS101" 的课程详情

**验证点**:
- ✅ 精确匹配课程代码
- ✅ 返回完整课程信息

---

#### TC-CS-004: 根据ID查询课程

**测试目标**: 验证按UUID查询课程

**请求**:
```bash
# 先获取课程ID
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

# 根据ID查询
curl http://localhost:8081/api/courses/$COURSE_ID
```

**预期结果**:
- HTTP状态码: `200 OK`
- 返回对应ID的课程详情

---

#### TC-CS-005: 更新课程信息

**测试目标**: 验证课程信息更新功能

**请求**:
```bash
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

curl -X PUT http://localhost:8081/api/courses/$COURSE_ID \
-H "Content-Type: application/json" \
-d '{
  "code": "CS101",
  "title": "计算机科学导论(更新)",
  "instructor": {
    "id": "T001",
    "name": "张教授",
    "email": "zhang@zjgsu.edu.cn"
  },
  "schedule": {
    "dayOfWeek": "TUESDAY",
    "startTime": "10:00",
    "endTime": "12:00"
  },
  "capacity": 80,
  "enrolled": 0,
  "expectedAttendance": 70
}'
```

**预期结果**:
- HTTP状态码: `200 OK`
- 课程标题更新为 "计算机科学导论(更新)"
- 排课时间更新为周二 10:00-12:00
- 容量更新为80

**验证点**:
- ✅ 课程信息正确更新
- ✅ ID和createdAt保持不变

---

#### TC-CS-006: 增加选课人数

**测试目标**: 验证选课人数增加功能

**请求**:
```bash
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

curl -X POST http://localhost:8081/api/courses/$COURSE_ID/increment
```

**预期结果**:
- HTTP状态码: `200 OK`
- enrolled值增加1

---

#### TC-CS-007: 减少选课人数

**测试目标**: 验证退课人数减少功能

**请求**:
```bash
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

curl -X POST http://localhost:8081/api/courses/$COURSE_ID/decrement
```

**预期结果**:
- HTTP状态码: `200 OK`
- enrolled值减少1

---

#### TC-CS-008: 删除课程

**测试目标**: 验证删除课程功能

**请求**:
```bash
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

curl -X DELETE http://localhost:8081/api/courses/$COURSE_ID
```

**预期结果**:
- HTTP状态码: `200 OK`
- 课程成功删除
- 再次查询该课程返回404

---

#### TC-CS-009: 查询不存在的课程 (异常场景)

**测试目标**: 验证查询不存在课程的错误处理

**请求**:
```bash
curl http://localhost:8081/api/courses/non-existent-id
```

**预期结果**:
- HTTP状态码: `404 Not Found`
- 错误消息明确说明课程不存在

---

#### TC-CS-010: 创建重复课程代码 (异常场景)

**测试目标**: 验证课程代码唯一性约束

**请求**:
```bash
# 创建第一个课程
curl -X POST http://localhost:8081/api/courses \
-H "Content-Type: application/json" \
-d '{
  "code": "CS201",
  "title": "数据结构",
  "instructor": {"id": "T002", "name": "李教授", "email": "li@zjgsu.edu.cn"},
  "schedule": {"dayOfWeek": "WEDNESDAY", "startTime": "14:00", "endTime": "16:00"},
  "capacity": 50,
  "expectedAttendance": 45
}'

# 尝试创建相同课程代码
curl -X POST http://localhost:8081/api/courses \
-H "Content-Type: application/json" \
-d '{
  "code": "CS201",
  "title": "数据结构(重复)",
  "instructor": {"id": "T003", "name": "王教授", "email": "wang@zjgsu.edu.cn"},
  "schedule": {"dayOfWeek": "THURSDAY", "startTime": "10:00", "endTime": "12:00"},
  "capacity": 40,
  "expectedAttendance": 35
}'
```

**预期结果**:
- 第一次请求: HTTP状态码 `201 Created`
- 第二次请求: HTTP状态码 `400 Bad Request` 或 `409 Conflict`
- 错误消息提示课程代码重复

---

### Enrollment Service 测试

#### TC-ES-001: 创建学生 (正常流程)

**测试目标**: 验证能够成功创建学生

**请求**:
```bash
curl -X POST http://localhost:8082/api/students \
-H "Content-Type: application/json" \
-d '{
  "studentId": "2024001",
  "name": "张三",
  "major": "计算机科学与技术",
  "grade": 2024,
  "email": "zhangsan@zjgsu.edu.cn"
}'
```

**预期结果**:
- HTTP状态码: `201 Created`
- 响应体包含创建的学生对象
- ID自动生成 (UUID)
- createdAt自动设置

**验证点**:
- ✅ 学号唯一性
- ✅ 邮箱唯一性
- ✅ ID自动生成

---

#### TC-ES-002: 获取所有学生

**测试目标**: 验证获取学生列表功能

**请求**:
```bash
curl http://localhost:8082/api/students
```

**预期结果**:
- HTTP状态码: `200 OK`
- 返回学生数组
```json
{
  "status": "success",
  "code": 200,
  "data": [
    {
      "id": "...",
      "studentId": "2024001",
      "name": "张三",
      "major": "计算机科学与技术",
      "grade": 2024,
      "email": "zhangsan@zjgsu.edu.cn",
      "createdAt": "..."
    }
  ]
}
```

---

#### TC-ES-003: 根据ID查询学生

**测试目标**: 验证根据UUID查询学生

**请求**:
```bash
STUDENT_ID=$(curl -s http://localhost:8082/api/students | jq -r '.data[0].id')

curl http://localhost:8082/api/students/$STUDENT_ID
```

**预期结果**:
- HTTP状态码: `200 OK`
- 返回学生详细信息

---

#### TC-ES-004: 更新学生信息

**测试目标**: 验证学生信息更新功能

**请求**:
```bash
STUDENT_ID=$(curl -s http://localhost:8082/api/students | jq -r '.data[0].id')

curl -X PUT http://localhost:8082/api/students/$STUDENT_ID \
-H "Content-Type: application/json" \
-d '{
  "studentId": "2024001",
  "name": "张三",
  "major": "软件工程",
  "grade": 2024,
  "email": "zhangsan@zjgsu.edu.cn"
}'
```

**预期结果**:
- HTTP状态码: `200 OK`
- major字段更新为 "软件工程"

---

#### TC-ES-005: 删除学生

**测试目标**: 验证删除学生功能

**请求**:
```bash
# 创建一个测试学生
curl -X POST http://localhost:8082/api/students \
-H "Content-Type: application/json" \
-d '{
  "studentId": "2024999",
  "name": "测试学生",
  "major": "测试专业",
  "grade": 2024,
  "email": "test999@zjgsu.edu.cn"
}'

# 获取学生ID
TEST_STUDENT_ID=$(curl -s http://localhost:8082/api/students | jq -r '.data[] | select(.studentId=="2024999") | .id')

# 删除学生
curl -X DELETE http://localhost:8082/api/students/$TEST_STUDENT_ID
```

**预期结果**:
- HTTP状态码: `200 OK`
- 删除成功消息
- 再次查询该学生返回404

---

#### TC-ES-006: 学生选课 (正常流程)

**测试目标**: 验证学生选课功能及服务间通信

**前置条件**:
- catalog-service中已存在课程
- enrollment-service中已存在学生

**请求**:
```bash
# 获取课程ID
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

# 创建选课记录
curl -X POST http://localhost:8082/api/enrollments \
-H "Content-Type: application/json" \
-d "{
  \"courseId\": \"$COURSE_ID\",
  \"studentId\": \"2024001\"
}"
```

**预期结果**:
- HTTP状态码: `201 Created`
- 返回选课记录:
```json
{
  "status": "success",
  "code": 201,
  "data": {
    "id": "...",
    "courseId": "...",
    "studentId": "2024001",
    "enrolledAt": "...",
    "status": "ACTIVE"
  }
}
```

**验证点**:
- ✅ enrollment-service成功调用catalog-service验证课程
- ✅ 选课记录创建成功
- ✅ 课程enrolled人数增加1 (在catalog-service中验证)

---

#### TC-ES-007: 获取所有选课记录

**测试目标**: 验证查询所有选课记录

**请求**:
```bash
curl http://localhost:8082/api/enrollments
```

**预期结果**:
- HTTP状态码: `200 OK`
- 返回选课记录数组

---

#### TC-ES-008: 按课程查询选课记录

**测试目标**: 验证按课程ID查询选课记录

**请求**:
```bash
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

curl http://localhost:8082/api/enrollments/course/$COURSE_ID
```

**预期结果**:
- HTTP状态码: `200 OK`
- 返回该课程的所有选课记录

---

#### TC-ES-009: 按学生查询选课记录

**测试目标**: 验证按学生学号查询选课记录

**请求**:
```bash
curl http://localhost:8082/api/enrollments/student/2024001
```

**预期结果**:
- HTTP状态码: `200 OK`
- 返回该学生的所有选课记录

---

#### TC-ES-010: 学生退课

**测试目标**: 验证学生退课功能

**请求**:
```bash
# 获取选课记录ID
ENROLLMENT_ID=$(curl -s http://localhost:8082/api/enrollments | jq -r '.data[0].id')

# 删除选课记录
curl -X DELETE http://localhost:8082/api/enrollments/$ENROLLMENT_ID
```

**预期结果**:
- HTTP状态码: `200 OK`
- 选课记录删除成功
- 课程enrolled人数减少1

---

#### TC-ES-011: 重复选课 (异常场景)

**测试目标**: 验证防止重复选课的约束

**请求**:
```bash
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

# 第一次选课(假设已经选过了)
curl -X POST http://localhost:8082/api/enrollments \
-H "Content-Type: application/json" \
-d "{
  \"courseId\": \"$COURSE_ID\",
  \"studentId\": \"2024001\"
}"

# 第二次选课(重复)
curl -X POST http://localhost:8082/api/enrollments \
-H "Content-Type: application/json" \
-d "{
  \"courseId\": \"$COURSE_ID\",
  \"studentId\": \"2024001\"
}"
```

**预期结果**:
- 第一次请求: `201 Created`
- 第二次请求: `400 Bad Request` 或 `409 Conflict`
- 错误消息提示已经选过该课程

---

#### TC-ES-012: 选课时课程不存在 (异常场景)

**测试目标**: 验证服务间通信的错误处理

**请求**:
```bash
curl -X POST http://localhost:8082/api/enrollments \
-H "Content-Type: application/json" \
-d '{
  "courseId": "non-existent-course-id",
  "studentId": "2024001"
}'
```

**预期结果**:
- HTTP状态码: `404 Not Found`
- 错误消息明确说明课程不存在

**验证点**:
- ✅ enrollment-service正确调用catalog-service
- ✅ 正确处理catalog-service返回的404错误
- ✅ 返回有意义的错误消息给客户端

---

#### TC-ES-013: 选课时学生不存在 (异常场景)

**测试目标**: 验证学生存在性检查

**请求**:
```bash
COURSE_ID=$(curl -s http://localhost:8081/api/courses | jq -r '.data[0].id')

curl -X POST http://localhost:8082/api/enrollments \
-H "Content-Type: application/json" \
-d "{
  \"courseId\": \"$COURSE_ID\",
  \"studentId\": \"non-existent-student\"
}"
```

**预期结果**:
- HTTP状态码: `404 Not Found`
- 错误消息说明学生不存在

---

### 服务间通信测试

#### TC-INT-001: catalog-service不可用时的处理

**测试目标**: 验证catalog-service宕机时enrollment-service的容错处理

**测试步骤**:
```bash
# 1. 停止catalog-service
docker-compose stop catalog-service

# 2. 尝试选课
COURSE_ID="some-course-id"
curl -X POST http://localhost:8082/api/enrollments \
-H "Content-Type: application/json" \
-d "{
  \"courseId\": \"$COURSE_ID\",
  \"studentId\": \"2024001\"
}"

# 3. 重启catalog-service
docker-compose start catalog-service
```

**预期结果**:
- 返回服务不可用错误(500 Internal Server Error)
- enrollment-service不会崩溃
- 重启后服务恢复正常

---

#### TC-INT-002: 课程容量限制测试

**测试目标**: 验证课程容量限制逻辑

**测试步骤**:
```bash
# 1. 创建容量为2的课程
curl -X POST http://localhost:8081/api/courses \
-H "Content-Type: application/json" \
-d '{
  "code": "CS999",
  "title": "测试课程",
  "instructor": {"id": "T999", "name": "测试教师", "email": "test@zjgsu.edu.cn"},
  "schedule": {"dayOfWeek": "FRIDAY", "startTime": "14:00", "endTime": "16:00"},
  "capacity": 2,
  "enrolled": 0,
  "expectedAttendance": 2
}'

# 2. 创建3个学生并尝试选课
# (学生1选课 - 成功)
# (学生2选课 - 成功)
# (学生3选课 - 应该失败，课程已满)
```

**预期结果**:
- 前2个学生选课成功
- 第3个学生选课失败，返回 "Course is full" 错误

---

#### TC-INT-003: 网络超时处理

**测试目标**: 验证服务间调用超时处理

**测试方法**: 
使用网络工具(如 `tc` 命令)模拟网络延迟，验证超时配置是否生效

---

## 自动化测试脚本

### 完整测试套件: `test-all-apis.sh`

```bash
#!/bin/bash
# test-all-apis.sh
# 自动化测试脚本 - 覆盖所有API端点

set -e  # 遇到错误立即退出

BASE_URL_CATALOG="http://localhost:8081"
BASE_URL_ENROLLMENT="http://localhost:8082"

echo "========================================="
echo "  校园选课系统微服务 - 自动化测试套件"
echo "========================================="
echo ""

# 颜色输出
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 测试计数器
PASSED=0
FAILED=0

# 测试函数
run_test() {
    local test_name=$1
    local test_command=$2
    local expected_status=$3
    
    echo -n "运行测试: $test_name ... "
    
    response=$(eval $test_command)
    status_code=$(echo "$response" | tail -n 1)
    
    if [[ "$status_code" == "$expected_status" ]]; then
        echo -e "${GREEN}✓ PASSED${NC}"
        ((PASSED++))
    else
        echo -e "${RED}✗ FAILED${NC} (期望: $expected_status, 实际: $status_code)"
        ((FAILED++))
    fi
}

echo "═══════════════════════════════════════"
echo "第一部分: Catalog Service API 测试"
echo "═══════════════════════════════════════"
echo ""

# TC-CS-001: 创建课程
echo ">>> TC-CS-001: 创建课程"
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST $BASE_URL_CATALOG/api/courses \
-H "Content-Type: application/json" \
-d '{
  "code": "CS101",
  "title": "计算机科学导论",
  "instructor": {
    "id": "T001",
    "name": "张教授",
    "email": "zhang@zjgsu.edu.cn"
  },
  "schedule": {
    "dayOfWeek": "MONDAY",
    "startTime": "08:00",
    "endTime": "10:00"
  },
  "capacity": 60,
  "enrolled": 0,
  "expectedAttendance": 50
}')
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" == "201" ]; then
    echo -e "${GREEN}✓ TC-CS-001 PASSED${NC}"
    ((PASSED++))
    echo "$RESPONSE_BODY" | jq '.'
else
    echo -e "${RED}✗ TC-CS-001 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-002: 获取所有课程
echo ">>> TC-CS-002: 获取所有课程"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_CATALOG/api/courses)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-CS-002 PASSED${NC}"
    ((PASSED++))
    # 保存课程ID供后续测试使用
    COURSE_ID=$(echo "$RESPONSE_BODY" | jq -r '.data[0].id')
    echo "课程数量: $(echo "$RESPONSE_BODY" | jq '.data | length')"
else
    echo -e "${RED}✗ TC-CS-002 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-003: 根据课程代码查询
echo ">>> TC-CS-003: 根据课程代码查询"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_CATALOG/api/courses/code/CS101)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-CS-003 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-CS-003 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-004: 根据ID查询课程
echo ">>> TC-CS-004: 根据ID查询课程"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_CATALOG/api/courses/$COURSE_ID)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-CS-004 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-CS-004 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-005: 更新课程
echo ">>> TC-CS-005: 更新课程信息"
RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT $BASE_URL_CATALOG/api/courses/$COURSE_ID \
-H "Content-Type: application/json" \
-d '{
  "code": "CS101",
  "title": "计算机科学导论(更新)",
  "instructor": {
    "id": "T001",
    "name": "张教授",
    "email": "zhang@zjgsu.edu.cn"
  },
  "schedule": {
    "dayOfWeek": "TUESDAY",
    "startTime": "10:00",
    "endTime": "12:00"
  },
  "capacity": 80,
  "enrolled": 0,
  "expectedAttendance": 70
}')
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-CS-005 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-CS-005 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-006: 增加选课人数
echo ">>> TC-CS-006: 增加选课人数"
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST $BASE_URL_CATALOG/api/courses/$COURSE_ID/increment)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-CS-006 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-CS-006 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-007: 减少选课人数
echo ">>> TC-CS-007: 减少选课人数"
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST $BASE_URL_CATALOG/api/courses/$COURSE_ID/decrement)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-CS-007 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-CS-007 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-009: 查询不存在的课程
echo ">>> TC-CS-009: 查询不存在的课程(异常场景)"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_CATALOG/api/courses/non-existent-id)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "404" ]; then
    echo -e "${GREEN}✓ TC-CS-009 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-CS-009 FAILED (HTTP: $HTTP_CODE, 期望: 404)${NC}"
    ((FAILED++))
fi
echo ""

echo "═══════════════════════════════════════"
echo "第二部分: Enrollment Service - 学生管理测试"
echo "═══════════════════════════════════════"
echo ""

# TC-ES-001: 创建学生
echo ">>> TC-ES-001: 创建学生"
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST $BASE_URL_ENROLLMENT/api/students \
-H "Content-Type: application/json" \
-d '{
  "studentId": "2024001",
  "name": "张三",
  "major": "计算机科学与技术",
  "grade": 2024,
  "email": "zhangsan@zjgsu.edu.cn"
}')
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" == "201" ]; then
    echo -e "${GREEN}✓ TC-ES-001 PASSED${NC}"
    ((PASSED++))
    echo "$RESPONSE_BODY" | jq '.'
else
    echo -e "${RED}✗ TC-ES-001 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-002: 获取所有学生
echo ">>> TC-ES-002: 获取所有学生"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_ENROLLMENT/api/students)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-002 PASSED${NC}"
    ((PASSED++))
    # 保存学生ID供后续测试使用
    STUDENT_UUID=$(echo "$RESPONSE_BODY" | jq -r '.data[0].id')
    echo "学生数量: $(echo "$RESPONSE_BODY" | jq '.data | length')"
else
    echo -e "${RED}✗ TC-ES-002 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-003: 根据ID查询学生
echo ">>> TC-ES-003: 根据ID查询学生"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_ENROLLMENT/api/students/$STUDENT_UUID)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-003 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-ES-003 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-004: 更新学生信息
echo ">>> TC-ES-004: 更新学生信息"
RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT $BASE_URL_ENROLLMENT/api/students/$STUDENT_UUID \
-H "Content-Type: application/json" \
-d '{
  "studentId": "2024001",
  "name": "张三",
  "major": "软件工程",
  "grade": 2024,
  "email": "zhangsan@zjgsu.edu.cn"
}')
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-004 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-ES-004 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

echo "═══════════════════════════════════════"
echo "第三部分: Enrollment Service - 选课管理测试"
echo "═══════════════════════════════════════"
echo ""

# TC-ES-006: 学生选课 (服务间通信测试)
echo ">>> TC-ES-006: 学生选课 (验证服务间通信)"
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST $BASE_URL_ENROLLMENT/api/enrollments \
-H "Content-Type: application/json" \
-d "{
  \"courseId\": \"$COURSE_ID\",
  \"studentId\": \"2024001\"
}")
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" == "201" ]; then
    echo -e "${GREEN}✓ TC-ES-006 PASSED (服务间通信成功)${NC}"
    ((PASSED++))
    ENROLLMENT_ID=$(echo "$RESPONSE_BODY" | jq -r '.data.id')
    echo "$RESPONSE_BODY" | jq '.'
else
    echo -e "${RED}✗ TC-ES-006 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-007: 获取所有选课记录
echo ">>> TC-ES-007: 获取所有选课记录"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_ENROLLMENT/api/enrollments)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-007 PASSED${NC}"
    ((PASSED++))
    echo "选课记录数量: $(echo "$RESPONSE_BODY" | jq '.data | length')"
else
    echo -e "${RED}✗ TC-ES-007 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-008: 按课程查询选课记录
echo ">>> TC-ES-008: 按课程查询选课记录"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_ENROLLMENT/api/enrollments/course/$COURSE_ID)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-008 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-ES-008 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-009: 按学生查询选课记录
echo ">>> TC-ES-009: 按学生查询选课记录"
RESPONSE=$(curl -s -w "\n%{http_code}" $BASE_URL_ENROLLMENT/api/enrollments/student/2024001)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-009 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-ES-009 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-012: 选课时课程不存在 (异常场景)
echo ">>> TC-ES-012: 选课时课程不存在(异常场景 - 服务间错误处理)"
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST $BASE_URL_ENROLLMENT/api/enrollments \
-H "Content-Type: application/json" \
-d '{
  "courseId": "non-existent-course-id",
  "studentId": "2024001"
}')
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "404" ]; then
    echo -e "${GREEN}✓ TC-ES-012 PASSED (正确处理课程不存在错误)${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-ES-012 FAILED (HTTP: $HTTP_CODE, 期望: 404)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-010: 学生退课
echo ">>> TC-ES-010: 学生退课"
RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE $BASE_URL_ENROLLMENT/api/enrollments/$ENROLLMENT_ID)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-010 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-ES-010 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-CS-008: 删除课程 (放到最后执行)
echo ">>> TC-CS-008: 删除课程"
RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE $BASE_URL_CATALOG/api/courses/$COURSE_ID)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-CS-008 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-CS-008 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# TC-ES-005: 删除学生
echo ">>> TC-ES-005: 删除学生"
RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE $BASE_URL_ENROLLMENT/api/students/$STUDENT_UUID)
HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)

if [ "$HTTP_CODE" == "200" ]; then
    echo -e "${GREEN}✓ TC-ES-005 PASSED${NC}"
    ((PASSED++))
else
    echo -e "${RED}✗ TC-ES-005 FAILED (HTTP: $HTTP_CODE)${NC}"
    ((FAILED++))
fi
echo ""

# 测试总结
echo ""
echo "========================================="
echo "           测试结果汇总"
echo "========================================="
echo -e "总测试数: $((PASSED + FAILED))"
echo -e "${GREEN}通过: $PASSED${NC}"
echo -e "${RED}失败: $FAILED${NC}"
echo ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}🎉 所有测试通过!${NC}"
    exit 0
else
    echo -e "${YELLOW}⚠ 有测试失败，请检查日志${NC}"
    exit 1
fi
```

### 使用方法

```bash
# 1. 赋予执行权限
chmod +x test-all-apis.sh

# 2. 运行测试
./test-all-apis.sh

# 3. 查看详细输出
./test-all-apis.sh | tee test-results.log
```

---

## 测试数据

### 课程测试数据

```json
{
  "code": "CS101",
  "title": "计算机科学导论",
  "instructor": {
    "id": "T001",
    "name": "张教授",
    "email": "zhang@zjgsu.edu.cn"
  },
  "schedule": {
    "dayOfWeek": "MONDAY",
    "startTime": "08:00",
    "endTime": "10:00"
  },
  "capacity": 60,
  "enrolled": 0,
  "expectedAttendance": 50
}
```

### 学生测试数据

```json
{
  "studentId": "2024001",
  "name": "张三",
  "major": "计算机科学与技术",
  "grade": 2024,
  "email": "zhangsan@zjgsu.edu.cn"
}
```

### 选课测试数据

```json
{
  "courseId": "<从catalog-service获取的课程UUID>",
  "studentId": "2024001"
}
```

---

## 测试检查清单

### 功能性测试
- [x] 所有CRUD操作正常工作
- [x] 服务间HTTP通信正常
- [x] 数据验证和约束生效
- [x] 错误处理符合预期

### 数据完整性测试
- [x] 唯一性约束生效 (课程代码、学号、邮箱)
- [x] 外键约束处理正确 (逻辑外键)
- [x] 自动生成字段正确 (ID, createdAt)

### 异常场景测试
- [x] 资源不存在返回404
- [x] 重复数据返回409
- [x] 服务不可用处理
- [x] 课程容量限制

### 服务间通信测试
- [x] enrollment-service能够调用catalog-service
- [x] 正确处理catalog-service的响应
- [x] 正确处理catalog-service的错误

---

## 性能测试建议

### 负载测试

使用Apache Bench进行简单负载测试:

```bash
# 测试获取所有课程的性能
ab -n 1000 -c 10 http://localhost:8081/api/courses

# 测试获取所有学生的性能
ab -n 1000 -c 10 http://localhost:8082/api/students
```

### 并发测试

测试并发选课场景:

```bash
# 多个学生同时选课
for i in {1..10}; do
  curl -X POST http://localhost:8082/api/enrollments \
  -H "Content-Type: application/json" \
  -d "{\"courseId\": \"$COURSE_ID\", \"studentId\": \"202400$i\"}" &
done
wait
```

---

## 已知问题

1. **分布式事务问题**: 
   - 现象: 选课成功后更新课程人数可能失败
   - 原因: 未实现分布式事务
   - 解决方案: 使用消息队列实现最终一致性

2. **并发选课超选问题**:
   - 现象: 高并发时可能超过课程容量
   - 原因: 缺少分布式锁
   - 解决方案: 引入Redis分布式锁或数据库乐观锁

3. **服务依赖问题**:
   - 现象: catalog-service宕机导致选课失败
   - 原因: 缺少服务降级和熔断机制
   - 解决方案: 引入Hystrix或Resilience4j

---

## 测试报告模板

### 测试执行记录

| 测试用例 | 执行日期 | 执行人 | 结果 | 备注 |
|---------|---------|--------|------|------|
| TC-CS-001 | 2025-11-20 | 测试员 | ✓ PASS | - |
| TC-CS-002 | 2025-11-20 | 测试员 | ✓ PASS | - |
| TC-ES-006 | 2025-11-20 | 测试员 | ✓ PASS | 服务间通信正常 |

### 缺陷记录

| 缺陷ID | 优先级 | 描述 | 状态 |
|--------|--------|------|------|
| BUG-001 | P2 | 并发选课可能超选 | Open |
| BUG-002 | P3 | 课程人数更新失败时无重试 | Open |

---

## 附录

### A. HTTP状态码说明

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 OK | 请求成功 | GET, PUT, DELETE成功 |
| 201 Created | 资源创建成功 | POST创建资源成功 |
| 400 Bad Request | 请求参数错误 | 验证失败 |
| 404 Not Found | 资源不存在 | 查询/操作不存在的资源 |
| 409 Conflict | 资源冲突 | 重复创建、唯一性约束冲突 |
| 500 Internal Server Error | 服务器错误 | 服务异常、数据库错误 |

### B. 常用curl命令参数

| 参数 | 说明 |
|------|------|
| `-X` | 指定HTTP方法 (GET, POST, PUT, DELETE) |
| `-H` | 添加请求头 |
| `-d` | 发送POST数据 |
| `-s` | 静默模式，不显示进度 |
| `-w` | 输出额外信息 (如HTTP状态码) |

### C. jq常用命令

| 命令 | 说明 |
|------|------|
| `jq '.'` | 格式化输出JSON |
| `jq '.data[0]'` | 获取data数组第一个元素 |
| `jq -r '.data[0].id'` | 提取id字段的值(原始字符串) |
| `jq '.data \| length'` | 获取数组长度 |

---

## 联系方式

如有问题，请联系:
- **项目负责人**: [你的名字]
- **邮箱**: [你的邮箱]
- **Git仓库**: [仓库地址]

---

**文档版本**: 1.0  
**最后更新**: 2025-11-20  
**文档状态**: ✅ 审核通过
